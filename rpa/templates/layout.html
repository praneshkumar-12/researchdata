{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'fonts/font-awesome-4.7.0/css/font-awesome.min.css' %}">
</head>
<body>
    <h1>Dashboard</h1>

    <form>
        <label for="searchBy">Search By:</label>
        <select id="searchBy" name="searchBy">
            <option value="title">Title</option>
            <option value="firstAuthor">First Author</option>
            <option value="secondAuthor">Second Author</option>
            <option value="thirdAuthor">Third Author</option>
            <option value="otherAuthors">Other Authors</option>
        </select>

        <label for="quartile">Quartile:</label>
        <select id="quartile" name="quartile">
            <option value="q1">Q1</option>
            <option value="q2">Q2</option>
            <option value="q3">Q3</option>
            <option value="q4">Q4</option>
        </select>

        <label for="AY">AY:</label>
        <select id="AY" name="AY">
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
        </select>

        <label>
            <input type="checkbox" name="scopus"> Scopus
        </label>

        <label>
            <input type="checkbox" name="webOfSciences"> Web of Sciences
        </label>

        <button class="submit-btn" type="submit">Search</button>
    </form>

    <div class="container" id="b1">
        <input type="text" class="form-control" id="searchBox" placeholder="Search..." oninput="filterTable()">
        <table class="table table-bordered table-striped">
            <thead class="bg-primary text-white">
                <tr>
                    <th>S.No</th>
                    <th>UniqueID</th>
                    <th>Title</th>
                    <th>Academic Year</th>
                    <th>First Author</th>
                    <th>Second Author</th>
                    <th>Third Author</th>
                    <th>Other Authors</th>
                    <th>Is Student Author</th>
                    <th>Student Name</th>
                    <th>Student Batch</th>
                    <th>Specification</th>
                    <th>Publication Type</th>
                    <th>Publication Name</th>
                    <th>Publisher</th>
                    <th>Publication Year</th>
                    <th>Publication Month</th>
                    <th>Volume</th>
                    <th>Page Numbers</th>
                    <th>Indexing</th>
                    <th>Quartile</th>
                    <th>Citations</th>
                    <th>DOI</th>
                    <th>FPP</th>
                    <th>URL</th>
                    <th>ISSN</th>
                    <th>Verification</th>
                    <!-- <th>TR Index</th>
                    <th>H index</th> -->
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for paper in papers %}
                <tr>
                    <td></td>
                    <td>{{ paper.uniqueid }}</td>
                    <td>{{ paper.title }}</td>
                    <td>{{ paper.start_academic_month }} {{ paper.start_academic_year }} - {{ paper.end_academic_month }} {{ paper.end_academic_year }}</td>
                    <td>{{ paper.first_author }}</td>
                    <td>{{ paper.second_author }}</td>
                    <td>{{ paper.third_author }}</td>
                    <td>{{ paper.other_authors }}</td>
                    <td>{{ paper.is_student_author }}</td>
                    <td>{{ paper.student_name }}</td>
                    <td>{{ paper.student_batch }}</td>
                    <td>{{ paper.specification }}</td>
                    <td>{{ paper.publication_type }}</td>
                    <td>{{ paper.publication_name }}</td>
                    <td>{{ paper.publisher }}</td>
                    <td>{{ paper.year_of_publishing }}</td>
                    <td>{{ paper.month_of_publishing }}</td>
                    <td>{{ paper.volume }}</td>
                    <td>{{ paper.page_number }}</td>
                    <td>{{ paper.indexing }}</td>
                    <td>{{ paper.quartile }}</td>
                    <td>{{ paper.citation }}</td>
                    <td>{{ paper.doi }}</td>
                    <td>{{ paper.front_page_path }}</td>
                    <td>{{ paper.url }}</td>
                    <td>{{ paper.issn }}</td>    
                    {% if paper.verified == 'False' %}
                    <td><button id="verificationButton" class="verify-btn" onclick="verify(this.value)" value="{{ paper.uniqueid }}">Verify</button></td>
                    {% endif %}
                    {% if paper.verified == 'True' %}
                    <td><button id="verificationButton" class="verified-btn" disabled>Verified</button></td> 
                    {% endif %}
                </tr>
                {% endfor %}
                <tr>
                    <td></td>
                    <td><input type="text" name="uniqueid" maxlength="100" id="id_uniqueid" disabled></td>
                    {% for field in form %}
                    {% if field.name == 'first_author' %}
                    <td>
                        <select id="id_AY" name="AY">
                            <option value="2022">JUL 2022 - JUN 2023</option>
                        </select>
                    </td>
                    {% endif %}
                    <td>{{ field }}</td>
                    {% endfor %}
                    <td><button id="fetchData" class="scrape-btn" onclick="scrapeData()">Fetch</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Bootstrap JS (Popper.js and Bootstrap JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/layout_script.js' %}"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
        
        document.addEventListener('DOMContentLoaded', function (){
            document.getElementById('id_uniqueid').disabled = true;
            document.getElementById('id_title').disabled = false;
            // document.getElementById('id_AY').state = 'disabled';
            document.getElementById('id_first_author').disabled = true;
            document.getElementById('id_second_author').disabled = true;
            document.getElementById('id_third_author').disabled = true;
            document.getElementById('id_other_authors').disabled = true;
            document.getElementById('id_is_student_author').disabled = true;
            document.getElementById('id_student_name').disabled = true;
            document.getElementById('id_student_batch').disabled = true;
            document.getElementById('id_specification').disabled = true;
            document.getElementById('id_publication_type').disabled = true;
            document.getElementById('id_publication_name').disabled = true;
            document.getElementById('id_publisher').disabled = true;
            document.getElementById('id_year_of_publishing').disabled = true;
            document.getElementById('id_month_of_publishing').disabled = true;
            document.getElementById('id_volume').disabled = true;
            document.getElementById('id_page_number').disabled = true;
            document.getElementById('id_indexing').disabled = true;
            document.getElementById('id_quartile').disabled = true;
            document.getElementById('id_citation').disabled = true;
            document.getElementById('id_doi').disabled = false;
            document.getElementById('id_front_page_path').disabled = true;
            document.getElementById('id_url').disabled = true;
            document.getElementById('id_issn').disabled = true;
            document.getElementById('fetchData').disabled = false;
        });
        function verify(uniqueid) {
                // Perform verification logic here
                // console.log(uniqueid)
                // Change button style


                $.ajax({
                    type: "POST",
                    url: "{% url 'verify_paper' %}", 
                    data: {csrfmiddlewaretoken: '{{ csrf_token }}',
                    uniqueid: uniqueid},
                    success: function(response){
                        alert(response);
                    }
                }
                );

                var btnelts = document.getElementsByClassName('verify-btn')
                
                var btnlen = btnelts.length
                for(var i = 0; i < btnlen; i++){
                    // console.log(btnelts[i])
                    if (btnelts[i].value == uniqueid){
                        var btn = btnelts[i]
                        break
                    }
                }
                // console.log(btn)
                btn.classList.remove('verify-btn');
                btn.classList.add('verified-btn');
                btn.innerText = "Verified";
            }

            function disableFetch(){
                fetch_btn = document.getElementById("fetchData");
                fetch_btn.disabled = true;
                fetch_btn.classList.remove("scrape-btn");
                fetch_btn.classList.add("scraped-btn");
                console.log("Changing class to disabled");
            }

            function enableFetch(){
                document.getElementById('fetchData').disabled = false;
                document.getElementById('fetchData').innerHTML = "Submit";
                console.log("Changing class to enabled");
                fetch_btn = document.getElementById("fetchData");
                fetch_btn.disabled = false;
                fetch_btn.classList.remove("scraped-btn");
                fetch_btn.classList.add("scrape-btn");
            }

            function scrapeData(){
                
        title_text = document.getElementById("id_title");
        doi_text = document.getElementById("id_doi");


        title = title_text.value;
        doi = doi_text.value;

        if (title == "" || doi == ""){
            alert("Please fill both title and DOI fields and try again!")
        }
        else{
            disableFetch();

            console.log(title, doi);

            var myResponse;
            
            $.ajaxSetup({async: false});

            $.ajax({
                        type: "POST",
                        url: "{% url 'scrape_data' %}", 
                        data: {csrfmiddlewaretoken: '{{ csrf_token }}',
                        title: title,
                        doi: doi},
                        success: function(response){
                            console.log(response.title, response.uniqueid);
                            alert(response);
                            myResponse = response;
                        }
                    }
                    );
                    
                    console.log(myResponse);
                    
            document.getElementById("id_uniqueid").value = myResponse.uniqueid;
            document.getElementById('id_title').disabled = true;
            // document.getElementById('id_AY').state = 'disabled';
            document.getElementById('id_first_author').disabled = false;
            document.getElementById('id_second_author').disabled = false;
            document.getElementById('id_third_author').disabled = false;
            document.getElementById('id_other_authors').disabled = false;
            document.getElementById('id_is_student_author').disabled = false;
            document.getElementById('id_student_name').disabled = false;
            document.getElementById('id_student_batch').disabled = false;
            document.getElementById('id_specification').disabled = false;
            document.getElementById('id_publication_type').disabled = false;
            document.getElementById('id_publication_name').disabled = false;
            document.getElementById('id_publisher').disabled = false;
            document.getElementById('id_year_of_publishing').disabled = false;
            document.getElementById('id_month_of_publishing').disabled = false;
            document.getElementById('id_volume').disabled = false;
            document.getElementById('id_page_number').disabled = false;
            document.getElementById('id_indexing').disabled = false;
            document.getElementById('id_quartile').disabled = false;
            document.getElementById('id_citation').disabled = false;
            document.getElementById('id_doi').disabled = true;
            document.getElementById('id_front_page_path').disabled = true;
            document.getElementById('id_url').disabled = false;
            document.getElementById('id_issn').disabled = false;
            document.getElementById('fetchData').disabled = false;
            document.getElementById('fetchData').innerHTML = "Submit";
            
            document.getElementById('id_first_author').value = myResponse.first_author;
            document.getElementById('id_second_author').value = myResponse.second_author;
            document.getElementById('id_third_author').value = myResponse.third_author;
            document.getElementById('id_other_authors').value = myResponse.other_authors;
            document.getElementById('id_is_student_author').value = myResponse.is_student_author;
            document.getElementById('id_student_name').value = myResponse.student_name;
            document.getElementById('id_student_batch').value = myResponse.student_batch;
            document.getElementById('id_specification').value = myResponse.specification;
            document.getElementById('id_publication_type').value = myResponse.publication_type;
            document.getElementById('id_publication_name').value = myResponse.publication_name;
            document.getElementById('id_publisher').value = myResponse.publisher;
            document.getElementById('id_year_of_publishing').value = myResponse.year_of_publishing;
            document.getElementById('id_month_of_publishing').value = myResponse.month_of_publishing;
            document.getElementById('id_volume').value = myResponse.volume;
            document.getElementById('id_page_number').value = myResponse.page_number;
            document.getElementById('id_indexing').value = myResponse.indexing;
            document.getElementById('id_quartile').value = myResponse.quartile;
            document.getElementById('id_citation').value = myResponse.citation;
            document.getElementById('id_doi').value = myResponse.doi;
            document.getElementById('id_front_page_path').value = "Yet to upload";
            document.getElementById('id_url').value = myResponse.url;
            document.getElementById('id_issn').value = myResponse.ISSN;
            
            
            enableFetch();
            
    }
}
    </script>
</body>
</html>


