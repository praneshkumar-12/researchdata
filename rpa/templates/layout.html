{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'fonts/font-awesome-4.7.0/css/font-awesome.min.css' %}">
</head>
<body>
    <h1>Dashboard</h1>

    <form>
        <label for="searchBy">Search By:</label>
        <select id="searchBy" name="searchBy">
            <option value="title">Title</option>
            <option value="firstAuthor">First Author</option>
            <option value="secondAuthor">Second Author</option>
            <option value="thirdAuthor">Third Author</option>
            <option value="otherAuthors">Other Authors</option>
        </select>

        <label for="quartile">Quartile:</label>
        <select id="quartile" name="quartile">
            <option value="q1">Q1</option>
            <option value="q2">Q2</option>
            <option value="q3">Q3</option>
            <option value="q4">Q4</option>
        </select>

        <label for="AY">AY:</label>
        <select id="AY" name="AY">
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
        </select>

        <label>
            <input type="checkbox" name="scopus"> Scopus
        </label>

        <label>
            <input type="checkbox" name="webOfSciences"> Web of Sciences
        </label>

        <button class="submit-btn" type="submit">Search</button>
    </form>

    <div class="container" id="b1">
        <input type="text" class="form-control" id="searchBox" placeholder="Search..." oninput="filterTable()">
        <table id="mytable" class="table table-bordered table-striped">
            <thead class="bg-primary text-white">
                <tr>
                    <th>S.No</th>
                    <th>UniqueID</th>
                    <th onclick="sortTable(2)">Title</th>
                    <th>Academic Year</th>
                    <th>First Author</th>
                    <th>Second Author</th>
                    <th>Third Author</th>
                    <th>Other Authors</th>
                    <th>Is Student Author</th>
                    <th>Student Name</th>
                    <th>Student Batch</th>
                    <th>Specification</th>
                    <th>Publication Type</th>
                    <th>Publication Name</th>
                    <th>Publisher</th>
                    <th onclick="sortTablenum(15)">Publication Year</th>
                    <th>Publication Month</th>
                    <th>Volume</th>
                    <th>Page Numbers</th>
                    <th>Indexing</th>
                    <th>Quartile</th>
                    <th onclick="sortTablenum(21)">Citations</th>
                    <th>DOI</th>
                    <th>FPP</th>
                    <th>URL</th>
                    <th>ISSN</th>
                    <th onclick="sortTable(26)">Verification</th>
                    <!-- <th>TR Index</th>
                    <th>H index</th> -->
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for paper in papers %}
                <tr>
                    <td></td>
                    <td>{{ paper.uniqueid }}</td>
                    <td>{{ paper.title }}</td>
                    <td>{{ paper.start_academic_month }} {{ paper.start_academic_year }} - {{ paper.end_academic_month }} {{ paper.end_academic_year }}</td>
                    <td>{{ paper.first_author }}</td>
                    <td>{{ paper.second_author }}</td>
                    <td>{{ paper.third_author }}</td>
                    <td>{{ paper.other_authors }}</td>
                    <td>{{ paper.is_student_author }}</td>
                    <td>{{ paper.student_name }}</td>
                    <td>{{ paper.student_batch }}</td>
                    <td>{{ paper.specification }}</td>
                    <td>{{ paper.publication_type }}</td>
                    <td>{{ paper.publication_name }}</td>
                    <td>{{ paper.publisher }}</td>
                    <td>{{ paper.year_of_publishing }}</td>
                    <td>{{ paper.month_of_publishing }}</td>
                    <td>{{ paper.volume }}</td>
                    <td>{{ paper.page_number }}</td>
                    <td>{{ paper.indexing }}</td>
                    <td>{{ paper.quartile }}</td>
                    <td>{{ paper.citation }}</td>
                    <td>{{ paper.doi }}</td>
                    <td>{{ paper.front_page_path }}</td>
                    <td><a href="{{ paper.url }}" target="_blank">{{ paper.url }}</a></td>
                    <td>{{ paper.issn }}</td>    
                    {% if paper.verified == 'False' %}
                    <td><button id="verificationButton" class="verify-btn" onclick="verify(this.value)" value="{{ paper.uniqueid }}">Verify</button></td>
                    {% endif %}
                    {% if paper.verified == 'True' %}
                    <td><button id="verificationButton" class="verified-btn" disabled>Verified</button></td> 
                    {% endif %}
                </tr>
                {% endfor %}
                <tr>
                    <td></td>
                    <td><input type="text" name="uniqueid" maxlength="100" id="id_uniqueid" disabled></td>
                    {% for field in form %}
                    {% if field.name == 'first_author' %}
                    <td>
                        <select id="id_AY" name="AY">
                            <option value="JUL 2022 - JUN 2023">JUL 2022 - JUN 2023</option>
                        </select>
                    </td>
                    {% endif %}
                    <td>{{ field }}</td>
                    {% endfor %}
                    <td><button id="fetchData" class="scrape-btn" onclick="scrapeData()">Fetch</button></td>
                </tr>
            </tbody>
        </table>
        <button id="downloadCSV" class="scrape-btn" onclick="downloadCSV()">Download CSV</button>
    </div>
</body>




    <!-- Bootstrap JS (Popper.js and Bootstrap JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/layout_script.js' %}"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('id_uniqueid').disabled = true;
    document.getElementById('id_title').disabled = true;
    document.getElementById('id_AY').disabled = true;
    document.getElementById('id_first_author').disabled = true;
    document.getElementById('id_second_author').disabled = true;
    document.getElementById('id_third_author').disabled = true;
    document.getElementById('id_other_authors').disabled = true;
    document.getElementById('id_is_student_author').disabled = true;
    document.getElementById('id_student_name').disabled = true;
    document.getElementById('id_student_batch').disabled = true;
    document.getElementById('id_specification').disabled = true;
    document.getElementById('id_publication_type').disabled = true;
    document.getElementById('id_publication_name').disabled = true;
    document.getElementById('id_publisher').disabled = true;
    document.getElementById('id_year_of_publishing').disabled = true;
    document.getElementById('id_month_of_publishing').disabled = true;
    document.getElementById('id_volume').disabled = true;
    document.getElementById('id_page_number').disabled = true;
    document.getElementById('id_indexing').disabled = true;
    document.getElementById('id_quartile').disabled = true;
    document.getElementById('id_citation').disabled = true;
    document.getElementById('id_doi').disabled = false;
    document.getElementById('id_front_page_path').disabled = true;
    document.getElementById('id_url').disabled = true;
    document.getElementById('id_issn').disabled = true;
    document.getElementById('fetchData').disabled = false;
});


function verify(uniqueid) {
    // Perform verification logic here
    // console.log(uniqueid)
    // Change button style


    $.ajax({
        type: "POST",
        url: "{% url 'verify_paper' %}",
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            uniqueid: uniqueid
        },
        success: function(response) {
            alert(response);
        }
    });

    var btnelts = document.getElementsByClassName('verify-btn')

    var btnlen = btnelts.length
    for (var i = 0; i < btnlen; i++) {
        // console.log(btnelts[i])
        if (btnelts[i].value == uniqueid) {
            var btn = btnelts[i]
            break
        }
    }
    // console.log(btn)
    btn.classList.remove('verify-btn');
    btn.classList.add('verified-btn');
    btn.innerText = "Verified";
}

function disableFetch() {
    fetch_btn = document.getElementById("fetchData");
    fetch_btn.disabled = true;
    fetch_btn.classList.remove("scrape-btn");
    fetch_btn.classList.add("scraped-btn");
    console.log("Changing class to disabled");
    document.getElementById('fetchData').innerHTML = "Fetching...";
}

function enableFetch() {
    document.getElementById('fetchData').disabled = false;
    document.getElementById('fetchData').innerHTML = "Submit";
    console.log("Changing class to enabled");
    fetch_btn = document.getElementById("fetchData");
    fetch_btn.disabled = false;
    fetch_btn.classList.remove("scraped-btn");
    fetch_btn.classList.add("scrape-btn");
}

function enableFetchNoResponse() {
    document.getElementById('fetchData').disabled = false;
    document.getElementById('fetchData').innerHTML = "Fetch";
    console.log("Changing class to enabled");
    fetch_btn = document.getElementById("fetchData");
    fetch_btn.disabled = false;
    fetch_btn.classList.remove("scraped-btn");
    fetch_btn.classList.add("scrape-btn");
}

function scrapeData() {

    title_text = document.getElementById("id_title");
    doi_text = document.getElementById("id_doi");


    title = title_text.value;
    doi = doi_text.value;

    if (doi == "") {
        alert("Please fill DOI field and try again!")
    } else {
        disableFetch();

        console.log(doi);

        var myResponse;

        setTimeout(function() {
            $.ajaxSetup({
                async: false
            });

            $.ajax({
                type: "POST",
                url: "{% url 'scrape_data' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    title: title,
                    doi: doi
                },
                success: function(response) {
                    console.log(response.title, response.uniqueid);
                    myResponse = response;
                }
            });



            console.log(myResponse);

            if (myResponse == "Cannot fetch data for the given search term!") {
                alert(myResponse);
                enableFetchNoResponse();
                return null;
            } else if (myResponse == "Cannot fetch only with DOI, please provide title also.") {
                alert(myResponse);
                enableFetchNoResponse();
                document.getElementById("id_title").disabled = false;
                return null;
            }

            document.getElementById("id_title").value = myResponse.title;
            document.getElementById("id_uniqueid").value = myResponse.uniqueid;
            document.getElementById('id_first_author').value = myResponse.first_author;
            document.getElementById('id_second_author').value = myResponse.second_author;
            document.getElementById('id_third_author').value = myResponse.third_author;
            document.getElementById('id_other_authors').value = myResponse.other_authors;
            document.getElementById('id_is_student_author').value = myResponse.is_student_author;
            document.getElementById('id_student_name').value = myResponse.student_name;
            document.getElementById('id_student_batch').value = myResponse.student_batch;
            document.getElementById('id_specification').value = myResponse.specification;
            document.getElementById('id_publication_type').value = myResponse.publication_type;
            document.getElementById('id_publication_name').value = myResponse.publication_name;
            document.getElementById('id_publisher').value = myResponse.publisher;
            document.getElementById('id_year_of_publishing').value = myResponse.year_of_publishing;
            document.getElementById('id_month_of_publishing').value = myResponse.month_of_publishing;
            document.getElementById('id_volume').value = myResponse.volume;
            document.getElementById('id_page_number').value = myResponse.page_number;
            document.getElementById('id_indexing').value = myResponse.indexing;
            document.getElementById('id_quartile').value = myResponse.quartile;
            document.getElementById('id_citation').value = myResponse.citation;
            document.getElementById('id_doi').value = myResponse.doi;
            document.getElementById('id_front_page_path').value = "Yet to upload";
            document.getElementById('id_url').value = myResponse.url;
            document.getElementById('id_issn').value = myResponse.ISSN;

            document.getElementById('id_title').disabled = myResponse.title == "NULL" ? false : true;
            document.getElementById('id_AY').disabled = false;
            document.getElementById('id_first_author').disabled = myResponse.first_author == "NULL" ? false : true;
            document.getElementById('id_second_author').disabled = myResponse.second_author == "NULL" ? false : true;
            document.getElementById('id_third_author').disabled = myResponse.third_author == "NULL" ? false : true;
            document.getElementById('id_other_authors').disabled = myResponse.other_authors == "NULL" ? false : true;
            document.getElementById('id_is_student_author').disabled = myResponse.is_student_author == "NULL" ? false : true;
            document.getElementById('id_student_name').disabled = myResponse.student_name == "NULL" ? false : true;
            document.getElementById('id_student_batch').disabled = myResponse.student_batch == "NULL" ? false : true;
            document.getElementById('id_specification').disabled = myResponse.specification == "NULL" ? false : true;
            document.getElementById('id_publication_type').disabled = myResponse.publication_type == "NULL" ? false : true;
            document.getElementById('id_publication_name').disabled = myResponse.publication_name == "NULL" ? false : true;
            document.getElementById('id_publisher').disabled = myResponse.publisher == "NULL" ? false : true;
            document.getElementById('id_year_of_publishing').disabled = myResponse.year_of_publishing == "NULL" ? false : true;
            document.getElementById('id_month_of_publishing').disabled = myResponse.month_of_publishing == "NULL" ? false : true;
            document.getElementById('id_volume').disabled = myResponse.volume == "NULL" ? false : true;
            document.getElementById('id_page_number').disabled = myResponse.page_number == "NULL" ? false : true;
            document.getElementById('id_indexing').disabled = myResponse.indexing == "NULL" ? false : true;
            document.getElementById('id_quartile').disabled = myResponse.quartile == "NULL" ? false : true;
            document.getElementById('id_citation').disabled = myResponse.citation == "NULL" ? false : true;
            document.getElementById('id_doi').disabled = true
            document.getElementById('id_front_page_path').disabled = true;
            document.getElementById('id_url').disabled = myResponse.url == "NULL" ? false : true;
            document.getElementById('id_issn').disabled = myResponse.ISSN == "NULL" ? false : true;
            document.getElementById('fetchData').disabled = false;
            document.getElementById('fetchData').innerHTML = "Submit";

            document.getElementById('fetchData').setAttribute('onclick', 'submitData()')

            enableFetch();

        }, 2500);

    }

}

function submitData() {

    uniqueid = document.getElementById('id_uniqueid').value;
    title = document.getElementById('id_title').value;
    AY = document.getElementById("id_AY").options[document.getElementById("id_AY").selectedIndex].value;
    first_author = document.getElementById('id_first_author').value;
    second_author = document.getElementById('id_second_author').value;
    third_author = document.getElementById('id_third_author').value;
    other_authors = document.getElementById('id_other_authors').value;
    is_student_author = document.getElementById('id_is_student_author').value;
    student_name = document.getElementById('id_student_name').value;
    student_batch = document.getElementById('id_student_batch').value;
    specification = document.getElementById('id_specification').value;
    publication_type = document.getElementById('id_publication_type').value;
    publication_name = document.getElementById('id_publication_name').value;
    publisher = document.getElementById('id_publisher').value;
    year_of_publishing = document.getElementById('id_year_of_publishing').value;
    month_of_publishing = document.getElementById('id_month_of_publishing').value;
    volume = document.getElementById('id_volume').value;
    page_number = document.getElementById('id_page_number').value;
    indexing = document.getElementById('id_indexing').value;
    quartile = document.getElementById('id_quartile').value;
    citation = document.getElementById('id_citation').value;
    doi = document.getElementById('id_doi').value;
    front_page_path = document.getElementById('id_front_page_path').value;
    url = document.getElementById('id_url').value;
    issn = document.getElementById('id_issn').value;

    // var myResponse;

    $.ajax({
        type: "POST",
        url: "{% url 'insert_paper' %}",
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            uniqueid: uniqueid,
            title: title,
            AY: AY,
            first_author: first_author,
            second_author: second_author,
            third_author: third_author,
            other_authors: other_authors,
            is_student_author: is_student_author,
            student_name: student_name,
            student_batch: student_batch,
            specification: specification,
            publication_type: publication_type,
            publication_name: publication_name,
            publisher: publisher,
            year_of_publishing: year_of_publishing,
            month_of_publishing: month_of_publishing,
            volume: volume,
            page_number: page_number,
            indexing: indexing,
            quartile: quartile,
            citation: citation,
            doi: doi,
            front_page_path: front_page_path,
            url: url,
            issn: issn
        },
        success: function(response) {
            alert(response);
            // myResponse = response;
        }
    });

    location.reload();
}

function formatDate(date) {
    var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
    var day = String(date.getDate()).padStart(2, '0');
    var hours = String(date.getHours()).padStart(2, '0');
    var minutes = String(date.getMinutes()).padStart(2, '0');
    var seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

function downloadCSV() {
    var csv_data = [];
    var rows = document.getElementsByTagName('tr');

    var counter = 1;

    var row_content = "";

    for (var i = 0; i < rows.length; i++) { // Exclude the last row
        // Check if the row is visible (style.display is not "none")
        if (i === rows.length - 1) {
            row_content = rows[i].querySelectorAll('td,th');
            content = row_content[1].innerHTML;
            if (content.includes("input")) {
                continue;
            }
        }
        if (window.getComputedStyle(rows[i]).display !== 'none') {
            var cols = rows[i].querySelectorAll('td,th');
            var csvrow = [];

            for (var j = 0; j < cols.length - 1; j++) {
                // console.log(cols[j].innerHTML)
                // Add automatic serial numbers for the first row
                if (i === 0 && j === 0) {
                    csvrow.push("Serial Number");
                } else {
                    if (i !== 0 && j === 0) {
                        csvrow.push(counter);
                        counter += 1;
                        continue;
                    }
                    // Add double quotes to the 8th column (index 7)
                    csvrow.push('"' + cols[j].innerHTML + '"');
                }
            }

            csv_data.push(csvrow.join(","));
        }
    }

    csv_data = csv_data.join('\n');
    downloadCSVFile(csv_data);
}

function downloadCSVFile(csv_data) {
    // Create CSV file object and feed
    // our csv_data into it
    CSVFile = new Blob([csv_data], {
        type: "text/csv"
    });

    // Create to temporary link to initiate
    // download process
    var temp_link = document.createElement('a');

    var currentDate = new Date();
    var formattedDate = formatDate(currentDate);

    // Download csv file
    temp_link.download = "research_papers_" + formattedDate + ".csv";
    var url = window.URL.createObjectURL(CSVFile);
    temp_link.href = url;

    // This link should not be displayed
    temp_link.style.display = "none";
    document.body.appendChild(temp_link);

    // Automatically click the link to
    // trigger download
    temp_link.click();
    document.body.removeChild(temp_link);
}

function lookForEmptySearch() {
    var input, filter, table, tr, td, i, j, txtValue;
    input = document.getElementById("searchBox");
    filter = input.value.toUpperCase();
    table = document.getElementById("tableBody");
    tr = table.getElementsByTagName("tr");

    if (filter === "") {

        for (i = 0; i < tr.length; i++) {
            tr[i].style.display = "";
        }
    }
}

function sortTable(n) {
      var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      table = document.getElementById("mytable");
      switching = true;
      // Set the sorting direction to ascending:
      dir = "asc";
      /* Make a loop that will continue until
      no switching has been done: */
      while (switching) {
        // Start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        /* Loop through all table rows (except the
        first, which contains table headers): */
        for (i = 1; i < (rows.length - 2); i++) {
          // Start by saying there should be no switching:
          shouldSwitch = false;
          /* Get the two elements you want to compare,
          one from current row and one from the next: */
          x = rows[i].getElementsByTagName("TD")[n];
          y = rows[i + 1].getElementsByTagName("TD")[n];
          /* Check if the two rows should switch place,
          based on the direction, asc or desc: */
          if (dir == "asc") {
            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
              // If so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          } else if (dir == "desc") {
            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
              // If so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          }
        }

        

        if (shouldSwitch) {
          /* If a switch has been marked, make the switch
          and mark that a switch has been done: */
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          // Each time a switch is done, increase this count by 1:
          switchcount ++;
        } else {
          /* If no switching has been done AND the direction is "asc",
          set the direction to "desc" and run the while loop again. */
          if (switchcount == 0 && dir == "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

function sortTablenum(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("mytable");
    switching = true;
    // Set the sorting direction to ascending:
    dir = "asc";
    /* Make a loop that will continue until
    no switching has been done: */
    while (switching) {
    // Start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /* Loop through all table rows (except the
    first, which contains table headers): */
    for (i = 1; i < (rows.length - 2); i++) {
        // Start by saying there should be no switching:
        shouldSwitch = false;
        /* Get the two elements you want to compare,
        one from current row and one from the next: */
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        /* Check if the two rows should switch place,
        based on the direction, asc or desc: */
        if (dir == "asc") {
        if (Number(x.innerHTML) > Number(y.innerHTML)) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
        }
        } else if (dir == "desc") {
        if (Number(x.innerHTML) < Number(y.innerHTML)) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
        }
        }
    }

    

    if (shouldSwitch) {
        /* If a switch has been marked, make the switch
        and mark that a switch has been done: */
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        // Each time a switch is done, increase this count by 1:
        switchcount ++;
    } else {
        /* If no switching has been done AND the direction is "asc",
        set the direction to "desc" and run the while loop again. */
        if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
        }
    }
    }
}



setInterval(lookForEmptySearch, 100);

</script>

</html>


